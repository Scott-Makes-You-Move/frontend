<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>OptiFit Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #ffffff;
        font-family: system-ui, sans-serif;
      }

      #botui-app {
        height: 100%;
        padding: 20px;
      }

      .botui-message-content {
        color: #145da0;
        font-family: inherit;
        font-size: 1rem;
      }
    </style>
  </head>

  <body>
    <div id="botui-app">
      <bot-ui></bot-ui>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/botui@0.3.9/build/botui.min.js"></script>
    <script>
      const botui = new BotUI('botui-app');
      let bearerToken = null;

      // Receive token from React ChatWidget
      window.addEventListener('message', function (event) {
        const { type, token } = event.data || {};

        if (type === 'SET_TOKEN') {
          bearerToken = token;
          botui.message.add({ content: '‚úÖ Token received. Starting chat...' });

          startConversation();
        }

        if (type === 'RESET_CHAT') {
          localStorage.clear();
          location.reload();
        }
      });

      async function startConversation() {
        if (!bearerToken) {
          console.warn('[BotUI] No bearer token. Cannot proceed.');
          await botui.message.add({
            content: '‚ö†Ô∏è Missing authentication. Please reload the chat.',
          });
          return;
        }

        // 1. Display loading message
        await botui.message.add({ content: '‚è≥ Loading your chat experience‚Ä¶' });

        // 2. Initiate API call
        try {
          const res = await fetch(
            'https://smym-backend-service.azurewebsites.net/api/v1/chatbot/initiate',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${bearerToken}`,
              },
              body: JSON.stringify({
                source: 'optifit-site',
                timestamp: new Date().toISOString(),
              }),
            },
          );

          if (!res.ok) {
            const errorText = await res.text();
            console.error('[BotUI] Initiate call failed:', res.status, errorText);
            await botui.message.add({
              content: `‚ö†Ô∏è Failed to connect (HTTP ${res.status})`,
            });
            return;
          }

          const data = await res.json();
          console.log('[BotUI] Init response:', data);

          await botui.message.add({
            content: data.message || 'üëã Hello! Welcome to OptiFit.',
          });

          // Proceed with next bot actions here (optional)
        } catch (error) {
          console.error('[BotUI] Network or server error:', error);
          await botui.message.add({
            content: '‚ö†Ô∏è Something went wrong while starting your chat.',
          });
        }
      }
    </script>
  </body>
</html>
